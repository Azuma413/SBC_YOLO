
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>簡単なビデオ通話アプリ</title>
  <style>
    video {
      width: 400px;  /* ビデオの幅 */
      height: 300px; /* ビデオの高さ */
      border: 1px solid black; /* ビデオの境界線 */
    }
  </style>
</head>
<body>
  <h1>通話相手を選択してください</h1>
  <button id="callButton">通話を開始</button> <!-- 通話を開始するボタン -->
  <video id="localVideo" autoplay muted></video> <!-- 自分のビデオ -->
  <video id="remoteVideo" autoplay></video> <!-- 相手のビデオ -->
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script> <!-- Socket.IOライブラリの読み込み -->
  <script>
    const socket = io('http://localhost:5000');  // Socket.IOサーバーのポートを指定
    let localConnection; // RTCPeerConnectionオブジェクト
    let localVideo = document.getElementById('localVideo'); // 自分のビデオ要素
    let remoteVideo = document.getElementById('remoteVideo'); // 相手のビデオ要素

    // ICEサーバーの設定
    const servers = {
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // STUNサーバーのURL
    };

    // ボタンを押したときの動作
    document.getElementById('callButton').addEventListener('click', async () => {
      localConnection = new RTCPeerConnection(servers); // 新しいRTCPeerConnectionオブジェクトを作成
      localConnection.onicecandidate = event => { // ICE候補を受信したときの処理
        if (event.candidate) {
          socket.emit('signal', { candidate: event.candidate }); // ICE候補をサーバーに送信
        }
      };

      localConnection.ontrack = event => { // リモートトラックを受信したときの処理
        remoteVideo.srcObject = event.streams[0]; // リモートビデオにストリームを設定
      };

      // メディアデバイスから音声とビデオのストリームを取得
      let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      stream.getTracks().forEach(track => localConnection.addTrack(track, stream)); // ストリームのトラックをローカル接続に追加
      localVideo.srcObject = stream; // 自分のビデオにストリームを設定

      let offer = await localConnection.createOffer(); // オファーを作成
      await localConnection.setLocalDescription(offer); // ローカル接続にオファーを設定
      socket.emit('signal', { sdp: offer }); // オファーをサーバーに送信
    });

    // シグナリング情報を受信したとき
    socket.on('signal', async data => {
      if (data.sdp) { // SDP情報がある場合
        await localConnection.setRemoteDescription(new RTCSessionDescription(data.sdp)); // リモートSDPを設定
        if (data.sdp.type === 'offer') { // 受信したSDPがオファーの場合
          let answer = await localConnection.createAnswer(); // アンサーを作成
          await localConnection.setLocalDescription(answer); // ローカル接続にアンサーを設定
          socket.emit('signal', { sdp: answer }); // アンサーをサーバーに送信
        }
      } else if (data.candidate) { // ICE候補がある場合
        await localConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); // ICE候補をローカル接続に追加
      }
    });
  </script>
</body>
</html>
        